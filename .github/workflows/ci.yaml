# SPDX-FileCopyrightText: Chris Wilson <christopher.david.wilson@gmail.com>
#
# SPDX-License-Identifier: Apache-2.0 OR MIT

---
name: CI

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
    tags:
      - "**"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  FORCE_COLOR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  pre-commit:
    name: Run pre-commit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
      - uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files --verbose
      - uses: pre-commit-ci/lite-action@v1.0.2
        if: always()

  # These checks are not included in pre-commit because they require network
  # access at runtime (e.g. to download schema files).
  online-checks:
    name: Checks that require network access
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      # Check JSON & YAML files
      - name: Install check-jsonschema
        run: uv tool install check-jsonschema --with jsonschema[format]
      - name: Check .markdownlint.yaml
        run: >-
          check-jsonschema
          --schemafile=https://raw.githubusercontent.com/DavidAnson/markdownlint/main/schema/markdownlint-config-schema.json
          .markdownlint.yaml
      - name: Check .pre-commit-config.yaml
        run: >-
          check-jsonschema
          --schemafile=https://json.schemastore.org/pre-commit-config.json
          .pre-commit-config.yaml
      - name: Check .prettierrc.yaml
        run: >-
          check-jsonschema
          --schemafile=https://json.schemastore.org/prettierrc.json
          .prettierrc.yaml
      - name: Check .yamllint.yaml
        run: >-
          check-jsonschema
          --schemafile=https://json.schemastore.org/yamllint.json
          .yamllint.yaml
      - name: Check cspell.config.yaml
        run: >-
          check-jsonschema
          --schemafile=https://raw.githubusercontent.com/streetsidesoftware/cspell/main/packages/cspell-types/cspell.schema.json
          cspell.config.yaml
      - name: Check package.json & package-lock.json
        run: >-
          check-jsonschema
          --schemafile=https://json.schemastore.org/package.json
          package.json
          package-lock.json
      - name: Check package.json & package-lock.json
        run: >-
          check-jsonschema
          --schemafile=https://json.schemastore.org/package.json
          package.json
          package-lock.json
      # Check TOML files
      # Note: taplo format is run as part of pre-commit
      - name: Install taplo
        run: uv tool install taplo
      - name: Lint TOML files
        run: taplo lint

  test:
    name: >-
      Python ${{ matrix.python-version }} on ${{ startsWith(matrix.os, 'macos-')
      && 'macOS' || startsWith(matrix.os, 'windows-')
      && 'Windows' || 'Linux' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # https://github.com/actions/checkout/issues/249
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install Hatch
        run: uv pip install --system --upgrade hatch
      - name: Run static analysis
        run: hatch fmt --check
      - name: Run tests
        run: >-
          hatch test
          --python ${{ matrix.python-version }}
          --cover
          --randomize
          --parallel
          --retries 2
          --retry-delay 1

  required-checks-pass:
    name: Ensure everything required is passing for branch protection
    if: always()
    needs:
      - test
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
