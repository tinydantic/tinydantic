# SPDX-FileCopyrightText: Chris Wilson <christopher.david.wilson@gmail.com>
#
# SPDX-License-Identifier: Apache-2.0 OR MIT

---
name: CI

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
    tags:
      - "**"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  FORCE_COLOR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  # pre-commit can modify files so we can't just run this as a step in the
  # matrix tests below. There is no way to disable this behavior, see
  # https://github.com/pre-commit/pre-commit-hooks/issues/108
  pre-commit:
    name: Run pre-commit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
      - uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files --verbose

  test:
    name: >-
      Python ${{ matrix.python-version }} on ${{ startsWith(matrix.os, 'macos-')
      && 'macOS' || startsWith(matrix.os, 'windows-')
      && 'Windows' || 'Linux' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # https://github.com/actions/checkout/issues/249
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install Hatch
        run: uv pip install --system --upgrade hatch
      - name: Run static analysis
        run: hatch fmt --check
      - name: Run tests
        run: >-
          hatch test
          --python ${{ matrix.python-version }}
          --cover
          --randomize
          --parallel
          --retries 2
          --retry-delay 1
